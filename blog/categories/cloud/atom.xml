<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: cloud | Daniels Cai's Blog]]></title>
  <link href="http://danielscai.github.com/blog/categories/cloud/atom.xml" rel="self"/>
  <link href="http://danielscai.github.com/"/>
  <updated>2013-04-12T10:06:17+08:00</updated>
  <id>http://danielscai.github.com/</id>
  <author>
    <name><![CDATA[Daniels Cai]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[openstack grizzly quantum-metadata-agent debug]]></title>
    <link href="http://danielscai.github.com/blog/2013/04/12/openstack-grizzly-quantum-metadata-agent-debug/"/>
    <updated>2013-04-12T09:36:00+08:00</updated>
    <id>http://danielscai.github.com/blog/2013/04/12/openstack-grizzly-quantum-metadata-agent-debug</id>
    <content type="html"><![CDATA[<p>一个错误的配置导致 quantum-metadata-agent 无法启动，也没有相关log</p>

<p>在<code>/var/log/quantum/metadata-agent.log</code> 中没有发现任何log</p>

<p>在<code>/var/log/syslog</code>中只有如下一条简单的错误日志</p>

<p><code>
Apr 11 15:24:47 network1 kernel: [ 4511.402916] init: quantum-metadata-agent main process (26599) terminated with status 1
</code></p>

<!-- more -->


<p>查看启动脚本 <code>/etc/init.d/quantum-metadata-agent</code> 发现是一个upstart job</p>

<p>查看 <code>/etc/init/quantum-metadata-agent.conf</code></p>

<p>```</p>

<h1>cat /etc/init/quantum-metadata-agent.conf</h1>

<p>description "Quantum metadata plugin agent"
author "Yolanda Robla <a href="&#109;&#x61;&#x69;&#x6c;&#116;&#x6f;&#x3a;&#x79;&#x6f;&#108;&#x61;&#110;&#x64;&#x61;&#46;&#x72;&#x6f;&#98;&#x6c;&#97;&#x40;&#x63;&#97;&#x6e;&#x6f;&#110;&#105;&#x63;&#x61;&#108;&#46;&#x63;&#x6f;&#x6d;">&#x79;&#111;&#x6c;&#97;&#x6e;&#100;&#97;&#46;&#114;&#x6f;&#x62;&#108;&#97;&#x40;&#x63;&#97;&#x6e;&#111;&#x6e;&#105;&#99;&#97;&#108;&#46;&#99;&#111;&#109;</a>"</p>

<p>start on runlevel [2345]
stop on runlevel [016]</p>

<p>chdir /var/run</p>

<p>pre-start script
mkdir -p /var/run/quantum
chown quantum:root /var/run/quantum
end script</p>

<p>exec start-stop-daemon --start --chuid quantum --exec /usr/bin/quantum-metadata-agent -- \</p>

<pre><code>        --config-file=/etc/quantum/quantum.conf --config-file=/etc/quantum/metadata_agent.ini \
        --log-file=/var/log/quantum/metadata-agent.log
</code></pre>

<p>```</p>

<p>手动运行这条命令,找到python的报错信息，提示配置文件错误 <code>Section must be started before assignment</code></p>

<p>```</p>

<h1>/usr/bin/quantum-metadata-agent --config-file=/etc/quantum/quantum.conf --config-file=/etc/quantum/metadata_agent.ini --log-file=/var/log/quantum/metadata-agent.log</h1>

<p>Traceback (most recent call last):
  File "/usr/bin/quantum-metadata-agent", line 20, in <module></p>

<pre><code>main()
</code></pre>

<p>  File "/usr/lib/python2.7/dist-packages/quantum/agent/metadata/agent.py", line 223, in main</p>

<pre><code>cfg.CONF(project='quantum')
</code></pre>

<p>  File "/usr/lib/python2.7/dist-packages/oslo/config/cfg.py", line 1180, in <strong>call</strong></p>

<pre><code>self._parse_config_files()
</code></pre>

<p>  File "/usr/lib/python2.7/dist-packages/oslo/config/cfg.py", line 1651, in _parse_config_files</p>

<pre><code>raise ConfigFileParseError(pe.filename, str(pe))
</code></pre>

<p>oslo.config.cfg.ConfigFileParseError: Failed to parse /etc/quantum/metadata_agent.ini: at /etc/quantum/metadata_agent.ini:3, Section must be started before assignment: None</p>

<p>```</p>

<p>导致这个错误的原因很简单 <code>/etc/quantum/metadata_agent.ini</code> 开头的<code>[DEFAULT]</code>被漏掉了</p>

<p>```</p>

<h1>cat /etc/quantum/metadata_agent.ini</h1>

<p>[DEFAULT]</p>

<h1>The Quantum user information for accessing the Quantum API.</h1>

<p>auth_url = http://controller1:35357/v2.0
auth_region = RegionOne
admin_tenant_name = service
admin_user = quantum
admin_password = service_pass</p>

<h1>IP address used by Nova metadata server</h1>

<p>nova_metadata_ip = 172.16.136.211</p>

<h1>TCP Port used by Nova metadata server</h1>

<p>nova_metadata_port = 8775</p>

<p>metadata_proxy_shared_secret = helloOpenStack</p>

<p>```</p>
]]></content>
  </entry>
  
</feed>
